# ================================================
# Rule name: Escalate - Malware (Wazuh VirusTotal + ML) -> IRIS
# Target Index: .internal.alerts-security.alerts-*
# ================================================

name: Malware Detection with Wazuh XDR
type: frequency
index: ".internal.alerts-security.alerts-*"

# Trigger ngay khi thấy 1 alert
num_events: 1
timeframe:
  minutes: 10

# Gom nhóm theo endpoint để tránh spam (có thể đổi sang data.virustotal.source.sha1)
query_key: agent.id

# =======================
# FILTER CONDITIONS
# =======================
filter:
  - bool:
      filter:
        # Lọc đúng rule_id của Elastic Security rule (rule_id trong Kibana)
        - term:
            kibana.alert.rule.rule_id: "433c6abf-df39-4fc2-9fc3-e15525cc392d"

        # # (Optional) Khóa thêm rule name cho chắc
        # - match_phrase:
        #     kibana.alert.rule.name: "Malware - Detection with Wazuh XDR"

        # # (Optional) Ensure là signal của Elastic Security
        # - term:
        #     event.kind: "signal"

        # (Optional) Bám sát logic gốc (giống KQL bạn set)
        # - term:
        #     data.integration: "virustotal"
        # - term:
        #     rule.id: "87105"
        # - term:
        #     ml.prediction.predicted_value: "WARNING"
        # - range:
        #     ml.prediction.prediction_probability:
        #       gte: 0.7

# =======================
# OPTIONS (FIX MISSING VALUE)
# =======================
realert:
  minutes: 5

alert_missing_value: "N/A"

# =======================
# ALERT TEXT (DEBUG / AUDIT)
# =======================
alert_subject: "Malware Detection with Wazuh XDR"
alert_subject_args:
  - agent.name
  - data.virustotal.source.file

alert_text_type: alert_text_only
alert_text_type: alert_text_only
alert_text: |
  # [Elastic Security] Malware Detection with Wazuh XDR

  ## Overview
  * **Use Case:** Malware Detected (Wazuh VirusTotal + ML)
  * **Rule Name:** {0}
  * **Reason:** {1}
  * **Severity / Risk:** {2} / {3}
  * **Time:** {4}

  ## Kibana Links
  * **Alert View:** {5}
  * **Data View (Discover Pivot):** https://elastic.cyberfortress.local/kibana/app/discover#/?_g=(filters:!(),refreshInterval:(pause:!t,value:60000),time:(from:now-1h,to:now))&_a=(columns:!(%27agent.id%27,%27ml_input%27,%27ml.prediction.predicted_value%27,%27ml.prediction.prediction_probability%27,%27data.virustotal.source.file%27,%27data.virustotal.source.sha1%27,%27data.virustotal.source.md5%27,%27data.virustotal.positives%27,%27data.virustotal.total%27),dataSource:(dataViewId:f410770f-a2da-47db-8a47-20b2ddbdcf5e,type:dataView),filters:!(),interval:auto,query:(language:kuery,query:%27data.integration:%20%22virustotal%22%20and%20rule.groups:%20%22virustotal%22%20and%20data.virustotal.found:%20%221%22%20and%20rule.id:%20%2287105%22%20and%20ml.prediction.predicted_value:%20%22WARNING%22%20and%20ml.prediction.prediction_probability%20%3E%3D%200.7%27),sort:!(!(%27%40timestamp%27,desc)))

  ## Primary Entity
  * **agent.id:** {6}
  * **agent.name:** {7}
  * **agent.ip:** {8}
  * **manager.name:** {9}

  ## ML Analysis
  * **ml_input:** {19}
  * **predicted_value:** {20}
  * **prediction_probability:** {21}
  * **model_id:** {22}

  ## Threat Context (VirusTotal)
  * **File:** {10}
  * **SHA1:** {11}
  * **MD5:** {12}
  * **Found:** {13}
  * **Malicious:** {14}
  * **Positives/Total:** {15}/{16}
  * **VT Link:** {17}
  * **VT Scan Date:** {18}

alert_text_args:
  - kibana.alert.rule.name
  - kibana.alert.reason
  - kibana.alert.severity
  - kibana.alert.risk_score
  - "@timestamp"
  - kibana.alert.url

  - agent.id
  - agent.name
  - agent.ip
  - manager.name

  - data.virustotal.source.file
  - data.virustotal.source.sha1
  - data.virustotal.source.md5
  - data.virustotal.found
  - data.virustotal.malicious
  - data.virustotal.positives
  - data.virustotal.total
  - data.virustotal.permalink
  - data.virustotal.scan_date

  - ml_input
  - ml.prediction.predicted_value
  - ml.prediction.prediction_probability
  - ml.prediction.model_id


# =======================
# ALERT DESTINATIONS
# =======================
alert:
  - "iris"

# =======================
# IRIS CONFIG
# =======================
# Tip: iris_host / iris_api_token thường set ở elastalert2_config.yaml (global).
# Nếu bạn muốn override per-rule thì khai báo tại đây:
# iris_host: "iris.cyberfortress.local"
# iris_api_token: "REPLACE_ME"

iris_type: alert
iris_ignore_ssl_errors: true
iris_overwrite_timestamp: true

iris_alert_source: "Elastic-Security-Escalation"
iris_alert_source_link: kibana.alert.url

# Severity mapping: 6 = Critical (theo ElastAlert2 docs)
iris_alert_severity_id: 6
iris_alert_status_id: 2   # New

iris_alert_tags: "Malware, Wazuh, VirusTotal, Elastic-Security, ML"

iris_alert_note: |
  Escalated from Elastic Security signal index.
  Elastic Rule ID: 433c6abf-df39-4fc2-9fc3-e15525cc392d
  Wazuh rule.id: 87105 (VirusTotal)
  Condition: predicted_value=WARNING AND probability>=0.7

# Map context để IRIS hiện đủ các field bạn yêu cầu
iris_alert_context:
  agent_id: agent.id
  agent_name: agent.name
  agent_ip: agent.ip
  manager_name: manager.name

  file_path: data.virustotal.source.file
  vt_sha1: data.virustotal.source.sha1
  vt_md5: data.virustotal.source.md5
  vt_found: data.virustotal.found
  vt_malicious: data.virustotal.malicious
  vt_positives: data.virustotal.positives
  vt_total: data.virustotal.total
  vt_permalink: data.virustotal.permalink
  vt_scan_date: data.virustotal.scan_date

  ml_input: ml_input
  ml_predicted_value: ml.prediction.predicted_value
  ml_prediction_probability: ml.prediction.prediction_probability
  ml_model_id: ml.prediction.model_id

  kibana_rule_name: kibana.alert.rule.name
  kibana_reason: kibana.alert.reason
  kibana_url: kibana.alert.url
  kibana_severity: kibana.alert.severity
  kibana_risk_score: kibana.alert.risk_score
  timestamp: "@timestamp"

# =======================
# IOC SECTION (IRIS)
# =======================
# LƯU Ý: ioc_type_id PHẢI khớp với IRIS instance của bạn.
# Bạn đã từng dùng IP với ioc_type_id=79, mình giữ nguyên.
# Với MD5/SHA1/Filepath, bạn cần map đúng ioc_type_id trên IRIS (xem note cuối).

iris_iocs:
  - ioc_value: agent.id
    ioc_description: "Unique identifier for the monitored endpoint in Wazuh"
    ioc_tlp_id: 2
    ioc_type_id: 135
    ioc_tags: "hostname, endpoint, wazuh"

  - ioc_value: agent.ip
    ioc_description: "IP address of the endpoint where malware was detected"
    ioc_tlp_id: 2
    ioc_type_id: 79
    ioc_tags: "ip, endpoint, wazuh"

  - ioc_value: data.virustotal.source.sha1
    ioc_description: "Malware file hash (SHA1) from Wazuh VirusTotal"
    ioc_tlp_id: 2
    ioc_type_id: 111
    ioc_tags: "sha1, hash, virustotal, malware"

  - ioc_value: data.virustotal.source.md5
    ioc_description: "Malware file hash (MD5) from Wazuh VirusTotal"
    ioc_tlp_id: 2
    ioc_type_id: 90
    ioc_tags: "md5, hash, virustotal, malware"

  - ioc_value: data.virustotal.source.file
    ioc_description: "Malware file path on endpoint"
    ioc_tlp_id: 2
    ioc_type_id: 97
    ioc_tags: "file, path, endpoint"

  - ioc_value: data.virustotal.permalink
    ioc_description: "VirusTotal report permalink"
    ioc_tlp_id: 2
    ioc_type_id: 85 
    ioc_tags: "url, virustotal, report"
